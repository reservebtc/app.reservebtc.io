# Docker container for identical testing environment
FROM node:22.14.0-alpine

# Metadata
LABEL maintainer="ReserveBTC Team"
LABEL description="Identical testing environment for ReserveBTC"
LABEL version="1.0.0"

# Install build dependencies for native modules
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    && ln -sf python3 /usr/bin/python

# Install exact npm version
RUN npm install -g npm@10.9.2

# Set working directory
WORKDIR /app

# Copy version configuration files
COPY .nvmrc .npmrc package*.json ./
COPY jest.config.js jest.setup.js .swcrc ./

# Install dependencies with exact versions (skip optional deps that need native compilation)
RUN npm ci --exact --frozen-lockfile --no-optional

# Copy source code
COPY . .

# Test environment variables (same as GitHub Actions)
ENV NODE_ENV=test
ENV CI=true
ENV FORCE_COLOR=3

# Version check for debugging
RUN echo "Node.js version: $(node --version)" && \
    echo "NPM version: $(npm --version)" && \
    echo "Working directory: $(pwd)" && \
    echo "Files in working directory:" && ls -la

# Run tests by default
CMD ["npm", "run", "test:all"]