#!/bin/bash

# Script to rewrite git history and change author/committer from Claude to ReserveBTC
# This will clean up the commit history to show proper ReserveBTC authorship

echo "ğŸ”„ Rewriting Git History - Changing authorship from Claude to ReserveBTC"
echo "============================================================"

# Backup current branch
echo "ğŸ“‹ Creating backup branch..."
git branch backup-before-rewrite

# Set new author information
export FILTER_BRANCH_SQUELCH_WARNING=1
NEW_NAME="ReserveBTC"
NEW_EMAIL="dev@reservebtc.io"

echo "ğŸ”§ New author info:"
echo "   Name: $NEW_NAME"
echo "   Email: $NEW_EMAIL"

# Rewrite git history to change author and committer
echo "ğŸ”„ Rewriting commit history..."
git filter-branch --env-filter "
    if [ \$GIT_COMMITTER_EMAIL = 'noreply@anthropic.com' ] || [ \$GIT_AUTHOR_EMAIL = 'noreply@anthropic.com' ]
    then
        export GIT_COMMITTER_NAME='$NEW_NAME'
        export GIT_COMMITTER_EMAIL='$NEW_EMAIL'
        export GIT_AUTHOR_NAME='$NEW_NAME'
        export GIT_AUTHOR_EMAIL='$NEW_EMAIL'
    fi
" --tag-name-filter cat -- --branches --tags

# Also rewrite any commits that might have Claude references
echo "ğŸ§¹ Cleaning up any remaining Claude references..."
git filter-branch -f --msg-filter "
    sed 's/Generated with \[Claude Code\]/Generated by ReserveBTC Team/g' |
    sed 's/Co-Authored-By: Claude <noreply@anthropic.com>/Co-Authored-By: ReserveBTC Team <dev@reservebtc.io>/g' |
    sed 's/ğŸ¤– Generated with Claude Code/ğŸš€ Built by ReserveBTC Team/g'
" -- --branches --tags

# Clean up backup refs
echo "ğŸ§¹ Cleaning up backup references..."
git for-each-ref --format="%(refname)" refs/original/ | xargs -n 1 git update-ref -d

# Force garbage collection
echo "ğŸ—‘ï¸  Running garbage collection..."
git gc --aggressive --prune=now

# Update git config for future commits
echo "âš™ï¸  Updating git config for future commits..."
git config user.name "ReserveBTC"
git config user.email "dev@reservebtc.io"

# Show the result
echo ""
echo "âœ… Git history rewrite completed!"
echo "============================================================"
echo "ğŸ“Š Recent commits now show:"
git log --oneline -5 --pretty=format:"%h %an <%ae> %s" HEAD

echo ""
echo ""
echo "ğŸ¯ Summary of changes:"
echo "   âœ… All commits now authored by: ReserveBTC <dev@reservebtc.io>"
echo "   âœ… Commit messages cleaned of Claude references"
echo "   âœ… Git config updated for future commits"
echo "   âœ… Backup created at: backup-before-rewrite branch"
echo ""
echo "ğŸš¨ WARNING: This rewrites git history!"
echo "   - All commit hashes have changed"
echo "   - You'll need to force push: git push origin main --force-with-lease"
echo "   - Other collaborators will need to reset their local branches"
echo ""
echo "ğŸ”„ Ready to push rewritten history to GitHub?"
echo "   Run: git push origin main --force-with-lease"
echo ""
echo "ğŸ“‹ If you need to restore original history:"
echo "   Run: git reset --hard backup-before-rewrite"